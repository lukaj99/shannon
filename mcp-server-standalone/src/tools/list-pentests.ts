import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { z } from "zod";
import { getClient } from "../temporal.js";

interface WorkflowSummary {
  workflowId: string;
  status: string;
  startTime: string;
  closeTime: string | null;
}

export function registerListPentests(server: McpServer): void {
  server.tool(
    "list_pentests",
    "List Shannon pentest workflows. Filter by status (running, completed, failed, or all).",
    {
      status: z
        .enum(["running", "completed", "failed", "all"])
        .optional()
        .describe("Filter by workflow status (default: all)"),
    },
    async ({ status }) => {
      const filterStatus = status ?? "all";

      try {
        const client = await getClient();

        let query = 'WorkflowType = "pentestPipelineWorkflow"';
        if (filterStatus === "running") {
          query += ' AND ExecutionStatus = "Running"';
        } else if (filterStatus === "completed") {
          query += ' AND ExecutionStatus = "Completed"';
        } else if (filterStatus === "failed") {
          query += ' AND ExecutionStatus = "Failed"';
        }
        query += " ORDER BY StartTime DESC";

        const workflows: WorkflowSummary[] = [];
        const iter = client.workflow.list({ query });

        for await (const wf of iter) {
          workflows.push({
            workflowId: wf.workflowId,
            status: wf.status.name,
            startTime: wf.startTime.toISOString(),
            closeTime: wf.closeTime?.toISOString() ?? null,
          });
          if (workflows.length >= 50) break;
        }

        const result = {
          filter: filterStatus,
          count: workflows.length,
          workflows,
        };

        return {
          content: [{ type: "text" as const, text: JSON.stringify(result, null, 2) }],
        };
      } catch (err) {
        const message = err instanceof Error ? err.message : String(err);
        return {
          content: [{ type: "text" as const, text: `Failed to list workflows: ${message}` }],
          isError: true,
        };
      }
    }
  );
}
