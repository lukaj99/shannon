import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { z } from "zod";
import { getClient } from "../temporal.js";
import type { PipelineInput } from "../types.js";

function sanitizeHostname(url: string): string {
  try {
    const hostname = new URL(url).hostname;
    return hostname.replace(/[^a-zA-Z0-9.-]/g, "_");
  } catch {
    return "unknown";
  }
}

export function registerStartPentest(server: McpServer): void {
  server.tool(
    "start_pentest",
    "Start a Shannon pentest workflow against a target URL with a local repository for code analysis. Returns the workflow ID for monitoring.",
    {
      webUrl: z.string().url().describe("Target URL to pentest (e.g. https://example.com)"),
      repoPath: z.string().describe("Absolute path to the target's source code repository"),
      configPath: z.string().optional().describe("Path to YAML config file (for auth, TOTP, custom params)"),
      pipelineTestingMode: z.boolean().optional().describe("Use minimal prompts for fast testing (default: false)"),
    },
    async ({ webUrl, repoPath, configPath, pipelineTestingMode }) => {
      try {
        const client = await getClient();

        const hostname = sanitizeHostname(webUrl);
        const workflowId = `${hostname}_shannon-${Date.now()}`;

        const input: PipelineInput = {
          webUrl,
          repoPath,
          ...(configPath !== undefined && { configPath }),
          ...(pipelineTestingMode !== undefined && { pipelineTestingMode }),
        };

        await client.workflow.start("pentestPipelineWorkflow", {
          taskQueue: "shannon-pipeline",
          workflowId,
          args: [input],
        });

        const result = {
          workflowId,
          status: "started",
          temporalWebUi: `http://localhost:8233/namespaces/default/workflows/${workflowId}`,
          monitorCommand: `./shannon query ID=${workflowId}`,
          logsCommand: `./shannon logs ID=${workflowId}`,
        };

        return {
          content: [{ type: "text" as const, text: JSON.stringify(result, null, 2) }],
        };
      } catch (err) {
        const message = err instanceof Error ? err.message : String(err);
        return {
          content: [{ type: "text" as const, text: `Failed to start pentest: ${message}` }],
          isError: true,
        };
      }
    }
  );
}
