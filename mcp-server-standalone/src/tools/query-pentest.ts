import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { z } from "zod";
import { getClient } from "../temporal.js";
import type { PipelineProgress } from "../types.js";

function formatDuration(ms: number): string {
  const seconds = Math.floor(ms / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  if (hours > 0) return `${hours}h ${minutes % 60}m`;
  if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
  return `${seconds}s`;
}

export function registerQueryPentest(server: McpServer): void {
  server.tool(
    "query_pentest",
    "Query the progress of a Shannon pentest workflow. Returns phase, agents, metrics, and status.",
    {
      workflowId: z.string().describe("The workflow ID returned by start_pentest"),
    },
    async ({ workflowId }) => {
      try {
        const client = await getClient();
        const handle = client.workflow.getHandle(workflowId);
        const progress = await handle.query<PipelineProgress>("getProgress");

        const summary = {
          workflowId: progress.workflowId,
          status: progress.status,
          currentPhase: progress.currentPhase,
          currentAgent: progress.currentAgent,
          elapsed: formatDuration(progress.elapsedMs),
          completedAgents: progress.completedAgents.length,
          totalAgents: 13,
          agents: progress.completedAgents.map((name) => {
            const m = progress.agentMetrics[name];
            return {
              name,
              duration: m ? formatDuration(m.durationMs) : "unknown",
              cost: m?.costUsd != null ? `$${m.costUsd.toFixed(4)}` : null,
              model: m?.model ?? null,
            };
          }),
          ...(progress.error && {
            error: progress.error,
            failedAgent: progress.failedAgent,
          }),
        };

        return {
          content: [{ type: "text" as const, text: JSON.stringify(summary, null, 2) }],
        };
      } catch (err) {
        const message = err instanceof Error ? err.message : String(err);
        if (message.includes("not found")) {
          return {
            content: [{ type: "text" as const, text: `Workflow not found: ${workflowId}` }],
            isError: true,
          };
        }
        return {
          content: [{ type: "text" as const, text: `Failed to query workflow: ${message}` }],
          isError: true,
        };
      }
    }
  );
}
